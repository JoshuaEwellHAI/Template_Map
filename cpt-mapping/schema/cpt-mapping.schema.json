{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://harrison.ai/schemas/cpt-mapping.schema.json",
  "title": "CPT Template Mapping Schema",
  "description": "Schema for mapping CPT codes to modular template components. IMPORTANT: The 'variant_id' field is an INTERNAL identifier only, NOT a CPT modifier. Official CMS-approved modifiers (like -26, -TC, -LT, -RT, -59) should use the 'cms_modifiers' array field when needed for billing.",
  "type": "object",
  "required": ["modality", "body_region", "category", "cpt_codes"],
  
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema"
    },
    "modality": {
      "type": "string",
      "enum": ["XR", "CT", "MRI", "US", "NM", "PET", "FLUORO", "MAMMO"],
      "description": "Imaging modality"
    },
    "body_region": {
      "type": "string",
      "description": "Primary body region (e.g., chest, abdomen, neuro)"
    },
    "category": {
      "type": "string",
      "description": "Human-readable category name"
    },
    "description": {
      "type": "string",
      "description": "Description of this mapping file"
    },
    "cpt_codes": {
      "type": "array",
      "items": { "$ref": "#/definitions/cpt_code_entry" },
      "description": "Array of CPT code definitions"
    },
    "special_protocols": {
      "type": "array",
      "items": { "$ref": "#/definitions/special_protocol" },
      "description": "Special reporting protocols (LI-RADS, Lung-RADS, etc.)"
    },
    "shared_components": {
      "$ref": "#/definitions/shared_components",
      "description": "Components shared across multiple CPT codes in this file"
    },
    "master_templates": {
      "type": "array",
      "items": { "$ref": "#/definitions/master_template" },
      "description": "Master templates referenced by this mapping"
    }
  },
  
  "definitions": {
    "cpt_code_entry": {
      "type": "object",
      "required": ["cpt_code", "procedure_name", "contrast"],
      "properties": {
        "cpt_code": {
          "type": "string",
          "pattern": "^[0-9]{5}$",
          "description": "5-digit CPT code"
        },
        "procedure_name": {
          "type": "string",
          "description": "Official procedure name"
        },
        "contrast": {
          "type": "string",
          "enum": ["without", "with", "with_without", "na"],
          "description": "Contrast administration type"
        },
        "protocol": {
          "type": "string",
          "description": "Special protocol identifier (e.g., cta, multiphase, lung_screening)"
        },
        "variants": {
          "type": "array",
          "items": { "$ref": "#/definitions/variant" },
          "description": "Template variants for this CPT code"
        },
        "components": {
          "$ref": "#/definitions/component_set",
          "description": "Default component set for this CPT code"
        },
        "special_elements": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Special elements required for this exam type"
        }
      }
    },
    
    "variant": {
      "type": "object",
      "required": ["variant_id"],
      "properties": {
        "variant_id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "INTERNAL identifier for this variant (e.g., 'routine', 'emergency', 'female'). This is NOT a CPT modifier - use 'cms_modifiers' for official CMS-approved modifiers."
        },
        "cms_modifiers": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[0-9A-Z]{2}$"
          },
          "description": "Official CMS-approved CPT modifiers (e.g., '26' for professional component, 'TC' for technical component, 'LT'/'RT' for laterality, '59' for distinct procedure). These are real billing modifiers appended to CPT codes."
        },
        "context": {
          "type": "string",
          "enum": ["routine", "outpatient", "inpatient", "emergency", "trauma", "icu", "screening", "diagnostic", "pe_protocol", "dissection_protocol", "high_resolution", "nodule_followup", "lung_cancer_screening", "renal_stone", "runoff", "ruq", "abdominal_wall", "inguinal", "with_doppler", "thyroid", "parathyroid", "soft_tissue_neck", "exercise", "pharmacologic", "amyloid", "neuroendocrine", "prostate", "breast", "melanoma", "myeloma"],
          "description": "Clinical context or protocol variant. These describe the clinical setting, not billing modifiers."
        },
        "gender": {
          "type": "string",
          "enum": ["male", "female"],
          "description": "Patient gender for anatomical variants"
        },
        "age_group": {
          "type": "string",
          "description": "Age group specification (e.g., '>40', '18-40', 'pediatric')"
        },
        "style": {
          "type": "string",
          "enum": ["structured", "free_text", "hybrid"],
          "description": "Reporting style"
        },
        "laterality": {
          "type": "string",
          "enum": ["unilateral", "bilateral", "left", "right"],
          "description": "Laterality specification for applicable exams"
        },
        "tracer": {
          "type": "string",
          "description": "Radiotracer used for nuclear medicine/PET studies"
        },
        "protocol": {
          "type": "string",
          "description": "Special protocol for this variant"
        },
        "add_on_cpt": {
          "type": "string",
          "pattern": "^[0-9]{5}$",
          "description": "Add-on CPT code billed with this variant (e.g., 93015 for stress testing, 93975 for Doppler)"
        },
        "template_name": {
          "type": "string",
          "description": "Name of the template in the source system"
        },
        "components_override": {
          "$ref": "#/definitions/component_set",
          "description": "Override component set for this specific variant"
        }
      }
    },
    
    "component_set": {
      "type": "object",
      "properties": {
        "header": {
          "type": "string",
          "pattern": "^HDR\\.",
          "description": "Header component reference"
        },
        "technique": {
          "type": "string",
          "pattern": "^TEC\\.",
          "description": "Technique component reference"
        },
        "findings": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Array of finding subcomponent references"
        },
        "impression": {
          "type": "string",
          "pattern": "^IMP\\.",
          "description": "Impression component reference"
        }
      }
    },
    
    "special_protocol": {
      "type": "object",
      "required": ["protocol_id", "name", "applicable_cpt"],
      "properties": {
        "protocol_id": {
          "type": "string",
          "description": "Unique protocol identifier"
        },
        "name": {
          "type": "string",
          "description": "Full protocol name"
        },
        "applicable_cpt": {
          "type": "array",
          "items": { "type": "string" },
          "description": "CPT codes that can use this protocol"
        },
        "templates": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Template names implementing this protocol"
        },
        "required_components": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Components required for this protocol"
        }
      }
    },
    
    "shared_components": {
      "type": "object",
      "properties": {
        "findings_subcomponents": {
          "type": "array",
          "items": { "$ref": "#/definitions/subcomponent" }
        },
        "icu_support_device_variants": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    
    "subcomponent": {
      "type": "object",
      "required": ["component_id", "name"],
      "properties": {
        "component_id": {
          "type": "string",
          "pattern": "^SUB\\.",
          "description": "Component identifier"
        },
        "name": {
          "type": "string",
          "description": "Human-readable name"
        },
        "description": {
          "type": "string",
          "description": "Description of what this component covers"
        },
        "references": {
          "type": "string",
          "description": "Reference to existing template in source system"
        },
        "atomic_elements": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Atomic elements (picklists) contained in this subcomponent"
        }
      }
    },
    
    "master_template": {
      "type": "object",
      "required": ["template_id"],
      "properties": {
        "template_id": {
          "type": "string",
          "description": "Template identifier in source system"
        },
        "description": {
          "type": "string",
          "description": "Description of the master template"
        },
        "usage": {
          "type": "string",
          "description": "How/when to use this template"
        }
      }
    }
  }
}
